(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function i(t){const r={};return t.integrity&&(r.integrity=t.integrity),t.referrerPolicy&&(r.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?r.credentials="include":t.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(t){if(t.ep)return;t.ep=!0;const r=i(t);fetch(t.href,r)}})();const p=(s,e=document)=>e.querySelector(s);function o(s,e={},i=[]){const n=document.createElement(s);return Object.entries(e).forEach(([t,r])=>{t==="class"?n.className=r:t.startsWith("on")&&typeof r=="function"?n.addEventListener(t.slice(2),r):r!==!1&&r!=null&&n.setAttribute(t,String(r))}),(Array.isArray(i)?i:[i]).forEach(t=>{t!=null&&n.appendChild(typeof t=="string"?document.createTextNode(t):t)}),n}function y(s="dicoding-story",e=2){return new Promise((i,n)=>{const t=indexedDB.open(s,e);t.onupgradeneeded=r=>{const a=r.target.result;if(!a.objectStoreNames.contains("stories")){const d=a.createObjectStore("stories",{keyPath:"id",autoIncrement:!0});d.createIndex("by_status","status",{unique:!1}),d.createIndex("isSaved","isSaved",{unique:!1})}a.objectStoreNames.contains("hidden_stories")||a.createObjectStore("hidden_stories",{keyPath:"id"})},t.onsuccess=()=>i(t.result),t.onerror=()=>n(t.error)})}async function I(s){const e=await y();return new Promise((i,n)=>{const a=e.transaction("stories","readwrite").objectStore("stories").add(s);a.onsuccess=()=>i(a.result),a.onerror=()=>n(a.error)})}async function D(){const s=await y();return new Promise((e,i)=>{const r=s.transaction("stories","readonly").objectStore("stories").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>i(r.error)})}async function C(s){const n=(await y()).transaction("stories","readwrite").objectStore("stories"),t={...s,isSaved:!0};return n.put(t)}async function M(s){const n=(await y()).transaction("stories","readwrite").objectStore("stories"),t={...s,isSaved:!1};return n.put(t)}async function j(){return(await D()).filter(e=>e.isSaved===!0)}async function N(s){const e=await y();return new Promise((i,n)=>{const a=e.transaction("stories","readwrite").objectStore("stories").delete(s);a.onsuccess=()=>i(!0),a.onerror=()=>n(a.error)})}async function O(s){const e=await y();return new Promise((i,n)=>{const a=e.transaction("hidden_stories","readwrite").objectStore("hidden_stories").put({id:s});a.onsuccess=()=>i(!0),a.onerror=()=>n(a.error)})}async function U(){const s=await y();return new Promise((e,i)=>{const r=s.transaction("hidden_stories","readonly").objectStore("hidden_stories").getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>i(r.error)})}class L{constructor(e){this.container=e,this.presenter=null}render(e="#/dashboard"){if(!this.container)return;this.container.innerHTML="";let i="Hallo selamat datang di Dashboard";e==="#/storyterbaru"&&(i="Story Terbaru (Data Lokal)"),e==="#/saved"&&(i="Story yang Anda Simpan");const n=o("div",{class:"hero-text"},[o("h2",{},i)]),t=o("div",{class:"stories-grid",id:"list"}),r=o("section",{},[n,o("div",{id:"status",style:"text-align:center; color:white; margin:10px 0;"}),t,o("div",{style:"display: flex; justify-content: center; gap: 20px; margin-top: 40px;"},[o("button",{style:"background-color: white; color: #024a7d; padding: 12px 30px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer;",onclick:()=>window.location.hash="#/dashboard"},"Kembali Ke Beranda"),o("button",{style:"background-color: #ff4757; color: white; padding: 12px 30px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer;",onclick:()=>{confirm("Keluar dari aplikasi?")&&(localStorage.removeItem("token"),window.location.hash="#/")}},"Keluar Aplikasi")])]);this.container.append(r)}async renderStories(e,i=!1,n=!1){const t=document.getElementById("list");if(!t)return;const a=(await U()).map(l=>l.id),d=e.filter(l=>!a.includes(l.id));t.innerHTML=d.length?"":"<p style='color:white;'>Belum ada data untuk ditampilkan.</p>",(window.location.hash==="#/dashboard"||window.location.hash==="#/"||window.location.hash==="")&&(i=!0,n=!1),d.slice(0,9).forEach(l=>{let u="";i&&(n?u=o("button",{style:"margin-top: 10px; padding: 8px 15px; background: #f39c12; border: none; color: white; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold;",onclick:async b=>{if(b.stopPropagation(),confirm("Batalkan penyimpanan story ini?")){await M(l);const k=d.filter(S=>S.id!==l.id);this.renderStories(k,i,n),alert("Story dihapus dari koleksi Simpan.")}}},"Batalkan di Simpan"):u=o("button",{style:"margin-top: 10px; padding: 8px 15px; background: #5fb8e8; border: none; color: white; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold;",onclick:async b=>{b.stopPropagation(),await C(l),alert("Story berhasil disimpan ke koleksi 'Story di Simpan'!")}},"Simpan Story"));const m=i?o("button",{style:"margin-top: 5px; padding: 8px 15px; background: #ff4757; border: none; color: white; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold;",onclick:async b=>{if(b.stopPropagation(),confirm("Yakin ingin menghapus story ini secara permanen?"))try{await N(l.id),await O(l.id);const k=d.filter(S=>S.id!==l.id);this.renderStories(k,i,n),alert("Story berhasil dihapus permanen!")}catch(k){console.error(k),alert("Gagal menghapus story.")}}},"Hapus Story"):"",g=o("img",{src:l.photoUrl||l.image,alt:`Foto cerita oleh ${l.name}`,style:"width: 100%; height: 200px; object-fit: cover;"});g.onerror=()=>{g.src="https://via.placeholder.com/300?text=Gambar+Rusak"};const v=o("article",{class:"card-story",style:"cursor:pointer;"},[g,o("div",{class:"card-body"},[o("h3",{class:"card-title"},l.name),o("p",{class:"card-desc"},l.description),u,m])]);v.addEventListener("click",()=>window.location.hash=`#/detail/${l.id}`),t.appendChild(v)})}showLoading(e){const i=p("#status");i&&(i.textContent=e)}}let h=null;const x=window.L;function B(s,e={}){if(h&&(h.remove(),h=null),!document.getElementById(s)||!x)return null;const{center:n=[-6.2,106.8],zoom:t=10,onClick:r}=e;return h=x.map(s).setView(n,t),x.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(h),r&&h.on("click",a=>r(a.latlng)),h}function A(s,e,i,n=""){if(!s||!x)return null;const t=x.marker([e,i]).addTo(s);return n&&t.bindPopup(n).openPopup(),t}function _(){h&&(h.remove(),h=null)}class F{constructor(e,i,n){this.video=e,this.canvas=i,this.btnCapture=n,this.stream=null,this.currentBlob=null,this._boundCapture=null}async start(e={video:!0,audio:!1}){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not supported in this browser.");try{this.stream=await navigator.mediaDevices.getUserMedia(e),this.video.srcObject=this.stream,this.video.setAttribute("playsinline",""),this.video.setAttribute("autoplay",""),await this.video.play(),this._boundCapture=()=>this.capture(),this.btnCapture&&this.btnCapture.addEventListener("click",this._boundCapture)}catch(i){throw new Error("Failed to start camera: "+i.message)}}stop(){if(this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.video){try{this.video.pause()}catch{}this.video.srcObject=null}this.btnCapture&&this._boundCapture&&(this.btnCapture.removeEventListener("click",this._boundCapture),this._boundCapture=null)}capture(){return new Promise((e,i)=>{if(!this.video||!this.canvas)return i(new Error("Video or canvas element is missing."));const n=this.video.videoWidth||this.video.clientWidth,t=this.video.videoHeight||this.video.clientHeight;if(!n||!t)return i(new Error("Video metadata not ready."));const r=this.canvas.getContext("2d");if(!r)return i(new Error("2D context not available on canvas."));if(this.canvas.width=n,this.canvas.height=t,r.drawImage(this.video,0,0,n,t),this.canvas.toBlob)this.canvas.toBlob(a=>{if(!a)return i(new Error("Failed to create image blob."));this.currentBlob=a,e(a)},"image/jpeg",.9);else try{const d=this.canvas.toDataURL("image/jpeg",.9).split(","),c=d[0].match(/:(.*?);/)[1],l=atob(d[1]);let u=l.length;const m=new Uint8Array(u);for(;u--;)m[u]=l.charCodeAt(u);const g=new Blob([m],{type:c});this.currentBlob=g,e(g)}catch(a){i(a)}})}getBlob(){return this.currentBlob}}class K{constructor(e){this.container=e,this.presenter=null,this._cam=null,this._map=null,this._marker=null,this._picked=null}async _toBase64(e){return new Promise((i,n)=>{const t=new FileReader;t.onload=()=>i(t.result),t.onerror=r=>n(r),t.readAsDataURL(e)})}render(){if(!this.container)return;this.container.innerHTML="";const e=o("div",{class:"hero-text"},[o("h2",{},"Tambah Story"),o("p",{},"Unggah foto dan pilih lokasimu di peta.")]),i=o("form",{id:"addForm",class:"panel-container"},[o("div",{class:"panel-box"},[o("label",{class:"panel-title"},"1. Foto & Cerita"),o("label",{for:"fileInput",style:"margin-bottom:5px; display:block;"},"Pilih Foto:"),o("div",{class:"kv",style:"display:flex; gap:10px; margin-bottom:10px;"},[o("button",{type:"button",id:"openCam",class:"button",style:"font-size:0.8rem; flex:1; padding:8px;"},"Buka Kamera"),o("input",{type:"file",id:"fileInput",accept:"image/*",style:"color:white; flex:2;"})]),o("div",{class:"kv",style:"flex-direction:column"},[o("video",{id:"video",playsinline:!0,style:"width:100%; border-radius:.5rem; display:none; margin-bottom:10px;"}),o("canvas",{id:"canvas",style:"width:100%; border-radius:.5rem; display:none; margin-bottom:10px;"}),o("button",{type:"button",id:"capture",class:"button warn",style:"display:none; width:100%;"},"Ambil Foto")]),o("label",{for:"desc",style:"margin-top:1rem; display:block;"},"Deskripsi:"),o("textarea",{id:"desc",name:"description",required:!0,maxlength:300,style:"color:black; width:100%;"})]),o("div",{class:"panel-box"},[o("label",{class:"panel-title"},"2. Lokasi (Wajib Dipilih)"),o("div",{id:"add-story-map",style:"height: 300px; width: 100%; border-radius: 10px;"}),o("p",{class:"helper"},["Koordinat: ",o("span",{id:"picked",style:"font-weight:bold; color: #ffeb3b;"},"Belum dipilih")]),o("button",{type:"submit",class:"btn-upload"},"Kirim Story")]),o("div",{id:"status",style:"width:100%; text-align:center; margin-top: 10px; font-weight: bold; color: white;"})]),n=o("div",{style:"display: flex; justify-content: center; gap: 20px; margin-top: 40px; padding-bottom: 30px;"},[o("button",{style:"background-color: white; color: #024a7d; padding: 12px 30px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer;",onclick:()=>window.location.hash="#/dashboard"},"Kembali Ke Beranda"),o("button",{style:"background-color: #ff4757; color: white; padding: 12px 30px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer;",onclick:()=>{confirm("Keluar dari aplikasi?")&&(localStorage.removeItem("token"),window.location.hash="#/")}},"Keluar Aplikasi")]);this.container.append(e,i,n);const t=p("#video"),r=p("#canvas"),a=p("#capture");this._cam=new F(t,r,a),p("#openCam").addEventListener("click",()=>{var d;t.style.display="block",a.style.display="inline-block",(d=this._cam)==null||d.start()}),requestAnimationFrame(()=>{_(),this._map=B("add-story-map",{center:[-6.2,106.8],zoom:5,onClick:d=>{this._picked=d,p("#picked").textContent=`${d.lat.toFixed(6)}, ${d.lng.toFixed(6)}`,this._marker&&this._map.removeLayer(this._marker),this._marker=A(this._map,d.lat,d.lng)}})}),p("#addForm").addEventListener("submit",async d=>{if(d.preventDefault(),!this._picked)return alert("Pilih lokasi di peta!");const c=p("#desc").value,l=p("#fileInput").files[0];let u="https://via.placeholder.com/300";r.style.display!=="none"?u=r.toDataURL():l&&(u=await this._toBase64(l));const m=Number(this._picked.lat),g=Number(this._picked.lng),v={id:`local-${Date.now()}`,name:"Saya (Lokal)",description:c,photoUrl:u,createdAt:new Date().toISOString(),lat:m,lon:g};try{this.showLoading("Menyimpan data...","white"),await I(v),this.presenter&&this.presenter.addStory({description:c,photo:l||this._cam.getImageFile(),lat:m,lon:g}),this.showLoading("Story berhasil di tambahkan dan di simpan","#4caf50"),p("#addForm").reset(),t.style.display="none",r.style.display="none",a.style.display="none",this._marker&&(this._map.removeLayer(this._marker),this._marker=null),this._picked=null,p("#picked").textContent="Belum dipilih",setTimeout(()=>{this.showLoading("")},3e3)}catch(b){console.error(b),this.renderError("Gagal menyimpan story.")}})}showLoading(e,i="white"){const n=p("#status");n&&(n.textContent=e,n.style.color=i)}renderError(e){const i=p("#status");i&&(i.textContent=e,i.style.color="red")}destroy(){var e;_(),(e=this._cam)==null||e.stop()}}class ${constructor(e){this.container=e,this.presenter=null,this._map=null}render(){if(!this.container)return;this.container.innerHTML="";const e=o("div",{class:"hero-text",style:"text-align:left; margin-bottom: 20px;"},[o("h2",{},"Detail status kamu")]),i=o("div",{id:"loading",style:"text-align:center; color:white;"},"Sedang memuat data..."),n=o("div",{id:"detailContent",style:"display: none; grid-template-columns: 1fr 1fr; gap: 20px;"});this.container.append(e,i,n)}showDetail(e){p("#loading")&&(p("#loading").style.display="none");const i=p("#detailContent");if(!i)return;i.style.display="grid",i.innerHTML="";const n=o("img",{src:e.photoUrl||e.image,alt:`Foto detail milik ${e.name}`,style:"width:100%; height:300px; object-fit:cover;"});n.onerror=()=>{n.src="https://via.placeholder.com/600?text=Gambar+Tidak+Ditemukan"};const t=o("div",{class:"card-story",style:"background:white; border-radius:10px; overflow:hidden;"},[n,o("div",{class:"card-body",style:"padding:15px; color:#333;"},[o("h3",{style:"margin-bottom:5px;"},e.name),o("p",{style:"color:#666;"},e.description),o("small",{style:"display:block; margin-top:10px; color:#999;"},new Date(e.createdAt).toLocaleString("id-ID",{dateStyle:"full",timeStyle:"short"}))])]),r=Number(e.lat),a=Number(e.lon),d=!isNaN(r)&&!isNaN(a)&&r!==0,c="detail-map",l=o("div",{class:"panel-box"},[o("h4",{style:"color:white; margin-bottom:10px;"},"Lokasi Status Mu :"),o("div",{id:c,style:"width:100%; height:250px; background:#eee; border-radius:8px; margin-bottom:10px;"}),o("p",{style:"color:#ffeb3b; font-weight:bold;"},d?`${r}, ${a}`:"Lokasi tidak tersedia")]);i.append(t,l),d&&setTimeout(()=>{this._map&&this._map.remove(),this._map=B(c,{center:[r,a],zoom:13});const m=`<div style="text-align:center;"><b>${e.name}</b><br>${e.description}</div>`;A(this._map,r,a,m)},500);const u=o("div",{style:"grid-column: 1 / -1; display: flex; justify-content: center; gap: 20px; margin-top: 20px; flex-wrap: wrap;"},[o("button",{style:"background:white; color:#024a7d; padding:12px 30px; border-radius:50px; cursor:pointer; font-weight:bold; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);",onclick:()=>window.location.hash="#/dashboard"},"Kembali ke Beranda"),o("button",{style:"background:#5fb8e8; color:white; padding:12px 30px; border-radius:50px; cursor:pointer; font-weight:bold; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);",onclick:()=>window.location.hash="#/storyterbaru"},"Kembali ke Story Terbaru")]);i.append(u)}}class E{constructor(e,i){this.view=e,this.model=i,this.initListener()}initListener(){window.addEventListener("online",()=>{this.syncPendingStories()})}async getDetail(e){try{if(this.view.showLoading&&this.view.showLoading("Sedang mengambil detail..."),e&&(e.startsWith("dummy-")||e.startsWith("story-")&&e.length<10)){const t={id:e,name:"Pengguna (Data Dummy)",description:"Ini adalah data simulasi karena ID ini tidak ada di server.",photoUrl:`https://picsum.photos/seed/${e}/600/400`,lat:-6.2,lon:106.816666};await new Promise(r=>setTimeout(r,500)),this.view.showDetail&&this.view.showDetail(t);return}const i=await this.model.getDetail(e);if(i.error)throw new Error(i.message);const n=i.story;this.view.showDetail&&this.view.showDetail(n)}catch(i){console.error("Gagal getDetail:",i),this.view.renderError&&this.view.renderError("Gagal memuat detail story. Pastikan koneksi lancar atau ID valid.")}}async addStory(e){try{this.view.showLoading&&this.view.showLoading(!0),await this.model.addStory(e),this.view.renderSuccess&&this.view.renderSuccess("Berhasil diupload!")}catch(i){console.warn("Offline, simpan IDB...",i);const n={id:`offline-${Date.now()}`,payload:{description:e.description},status:"pending",createdAt:Date.now()};await I(n),this.view.renderSuccess&&this.view.renderSuccess("Disimpan offline.")}finally{this.view.showLoading&&this.view.showLoading(!1)}}async loadStories(){try{this.view.showLoading&&this.view.showLoading("Memuat cerita...");let e=[];try{e=(await this.model.getStories()).listStory||[]}catch{console.log("Offline/API Error")}const i=[];for(let t=1;t<=9;t++)i.push({id:`dummy-${t}`,name:`Pengguna ${t}`,description:`Contoh deskripsi dummy ${t}`,photoUrl:`https://picsum.photos/seed/${t}/600/400`,lat:-6.2,lon:106.8});const n=[...e,...i];this.view.renderStories&&this.view.renderStories(n)}catch{this.view.renderError&&this.view.renderError("Gagal memuat data.")}}async syncPendingStories(){}}const f="https://story-api.dicoding.dev/v1";class T{constructor(e){this.tokenProvider=e}getToken(){return this.tokenProvider()}async register({name:e,email:i,password:n}){const t=await fetch(`${f}/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,email:i,password:n})});if(!t.ok)throw new Error("REGISTER_FAILED");return t.json()}async login({email:e,password:i}){const n=await fetch(`${f}/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:i})});if(!n.ok)throw new Error("LOGIN_FAILED");return(await n.json()).loginResult.token}async getStories({page:e=1,size:i=15,withLocation:n=!0}={}){const t=this.tokenProvider();if(!t)throw new Error("UNAUTHORIZED");const r=new URL(`${f}/stories`);r.searchParams.set("page",e),r.searchParams.set("size",i),r.searchParams.set("location",n?"1":"0");const a=await fetch(r,{headers:{Authorization:`Bearer ${t}`}});if(!a.ok)throw new Error("GET_STORIES_FAILED");return a.json()}async getDetail(e){const i=this.tokenProvider();if(!i)throw new Error("UNAUTHORIZED");const n=await fetch(`${f}/stories/${e}`,{headers:{Authorization:`Bearer ${i}`}});if(!n.ok)throw new Error("DETAIL_FAILED");return n.json()}async addStory({description:e,photo:i,lat:n,lon:t}){const r=this.tokenProvider();if(!r)throw new Error("UNAUTHORIZED");const a=new FormData;a.append("description",e),a.append("photo",i),n&&a.append("lat",n),t&&a.append("lon",t);const d=await fetch(`${f}/stories`,{method:"POST",headers:{Authorization:`Bearer ${r}`},body:a});if(!d.ok)throw new Error("ADD_STORY_FAILED");return d.json()}async addStoryGuest({description:e,file:i,lat:n,lon:t}){const r=new FormData;r.append("description",e),i&&r.append("photo",i),typeof n=="number"&&r.append("lat",String(n)),typeof t=="number"&&r.append("lon",String(t));const a=await fetch(`${f}/stories/guest`,{method:"POST",body:r});if(!a.ok)throw new Error("ADD_STORY_FAILED");return a.json()}async subscribeToPush(e){const i=this.tokenProvider(),n=await fetch(`${f}/notifications/subscribe`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify(e)});if(!n.ok){const t=await n.json();throw new Error(t.message||"SUBSCRIBE_FAILED_SERVER")}return n.json()}}const H="BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk";class z{constructor(e){this.content=e,this.model=new T(()=>localStorage.getItem("token"))}render(){this.content.innerHTML=`
      <section style="padding: 20px; text-align: center; max-width: 600px; margin: 50px auto;">
        <h2>Pengaturan Notifikasi</h2>
        <p style="margin-bottom: 20px;">Aktifkan notifikasi untuk mendapatkan update berita terbaru.</p>
        
        <div id="msg-box" style="margin-bottom: 20px; font-weight: bold;"></div>
        
        <button id="btnSubscribe" style="display: none; background-color: #024a7d; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">
          Aktifkan Notifikasi
        </button>
        
        <button id="btnUnsubscribe" style="display: none; background-color: #ff4757; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">
          Matikan Notifikasi
        </button>
      </section>
    `,this._initLogic()}async _initLogic(){const e=document.getElementById("btnSubscribe"),i=document.getElementById("btnUnsubscribe"),n=document.getElementById("msg-box");if(!("serviceWorker"in navigator)||!("PushManager"in window)){n.innerText="Maaf, browser ini tidak mendukung Push Notification.";return}const t=await navigator.serviceWorker.ready;await t.pushManager.getSubscription()?(e.style.display="none",i.style.display="inline-block",console.log("Status: Sudah Subscribe")):(e.style.display="inline-block",i.style.display="none",console.log("Status: Belum Subscribe")),e.addEventListener("click",async()=>{try{if(n.innerText="Meminta izin notifikasi...",await Notification.requestPermission()!=="granted"){n.innerText="Izin notifikasi ditolak.";return}n.innerText="Mendaftarkan ke browser...";const d={userVisibleOnly:!0,applicationServerKey:this._urlBase64ToUint8Array(H)},c=await t.pushManager.subscribe(d);n.innerText="Mengirim data ke server...",await this.model.subscribeToPush(c.toJSON()),console.log("Berhasil Subscribe ke Server:",JSON.stringify(c)),n.innerText="Berhasil mengaktifkan notifikasi!",e.style.display="none",i.style.display="inline-block"}catch(a){console.error(a),n.innerText="Gagal subscribe: "+a.message;const d=await t.pushManager.getSubscription();d&&await d.unsubscribe()}}),i.addEventListener("click",async()=>{try{const a=await t.pushManager.getSubscription();a&&(await a.unsubscribe(),console.log("Berhasil Unsubscribe"),n.innerText="Notifikasi dimatikan.",e.style.display="inline-block",i.style.display="none")}catch(a){console.error(a),n.innerText="Gagal unsubscribe."}})}_urlBase64ToUint8Array(e){const i="=".repeat((4-e.length%4)%4),n=(e+i).replace(/-/g,"+").replace(/_/g,"/"),t=window.atob(n),r=new Uint8Array(t.length);for(let a=0;a<t.length;++a)r[a]=t.charCodeAt(a);return r}}const q=`
  <div class="landing-container">
    <h1 class="landing-title">Selamat datang di Dylan Story Super App</h1>
    <div class="landing-image-wrapper">
       <img src="https://images.unsplash.com/photo-1533738363-b7f9aef128ce?q=80&w=400&auto=format&fit=crop" 
            alt="Kucing Lucu" class="landing-image"
            style="display:block; border-radius:10px; width:300px; height:300px; object-fit:cover; margin: 0 auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
    </div>
    <div class="landing-buttons">
      <a href="#/login" class="btn-landing">Login</a>
      <a href="#/register" class="btn-landing">Register</a>
    </div>
  </div>
`,R=`
  <div class="auth-container">
    <div class="login-box">
      <h2>Masuk</h2>
      <form id="loginForm">
        <div class="input-group"><label>Email</label><input type="email" id="email" required class="form-control"></div>
        <div class="input-group"><label>Kata Sandi</label><input type="password" id="password" required class="form-control"></div>
        <button type="submit" class="btn-auth" id="loginBtn">Masuk</button>
      </form>
      <button class="btn-back" id="backBtn">Kembali</button>
      <p style="margin-top:10px">Belum punya akun? <a href="#/register">Daftar di sini</a></p>
    </div>
  </div>
`,W=`
  <div class="auth-container">
    <div class="register-box">
      <h2>Daftar</h2>
      <form id="registerForm">
        <div class="input-group"><label>Nama</label><input type="text" id="name" required class="form-control"></div>
        <div class="input-group"><label>Email</label><input type="email" id="email" required class="form-control"></div>
        <div class="input-group"><label>Kata Sandi</label><input type="password" id="password" required class="form-control"></div>
        <button type="submit" class="btn-auth" id="regBtn">Daftar</button>
      </form>
      <button class="btn-back" id="backBtn">Kembali</button>
      <p style="margin-top:10px">Sudah punya akun? <a href="#/login">Login di sini</a></p>
    </div>
  </div>
`,P=async()=>{const s=window.location.hash||"#/",e=document.querySelector("#mainContent"),i=document.querySelector("header");if(!e)return;s==="#/"||s==="#/login"||s==="#/register"?(document.body.className="auth-page",i&&i.classList.add("hidden")):(document.body.className="app-page",i&&i.classList.remove("hidden")),e.innerHTML="";const n=new T(()=>localStorage.getItem("token"));try{if(s==="#/")e.innerHTML=q;else if(s==="#/login")e.innerHTML=R,document.getElementById("loginForm").addEventListener("submit",async t=>{t.preventDefault();const r=document.getElementById("email").value,a=document.getElementById("password").value;try{const d=await n.login({email:r,password:a});localStorage.setItem("token",d),window.location.hash="#/dashboard"}catch(d){alert("Login Gagal: "+d.message)}}),document.getElementById("backBtn").addEventListener("click",()=>window.location.hash="#/");else if(s==="#/register")e.innerHTML=W,document.getElementById("registerForm").addEventListener("submit",async t=>{t.preventDefault();const r=document.getElementById("name").value,a=document.getElementById("email").value,d=document.getElementById("password").value;try{await n.register({name:r,email:a,password:d}),alert("Berhasil! Silakan Login."),window.location.hash="#/login"}catch(c){alert("Registrasi Gagal: "+c.message)}}),document.getElementById("backBtn").addEventListener("click",()=>window.location.hash="#/");else if(s==="#/dashboard"){const t=new L(e),r=new E(t,n);t.presenter=r,t.render(s),t.showLoading("Memuat data dari server..."),r.loadStories(),w(s)}else if(s==="#/storyterbaru"){const t=new L(e);t.render(s);const r=await D();t.renderStories(r,!0,!1),w(s)}else if(s==="#/saved"){const t=new L(e);t.render(s);const r=await j();t.renderStories(r,!0,!0),w(s)}else if(s==="#/about")G(e),w(s);else if(s==="#/add"){const t=new K(e),r=new E(t,n);t.presenter=r,t.render(),w(s)}else if(s==="#/notification")new z(e).render(),w(s);else if(s.startsWith("#/detail/")){const t=s.split("/")[2],r=new $(e);if(r.render(),t.startsWith("local-"))(async()=>{try{const c=(await D()).find(l=>l.id===t);c?r.showDetail(c):e.innerHTML='<h2 style="text-align:center; margin-top:50px;">Data Lokal Tidak Ditemukan</h2>'}catch(d){console.error(d),e.innerHTML='<p style="color:red; text-align:center;">Gagal memuat data lokal.</p>'}})();else{const a=new E(r,n);r.presenter=a,a.getDetail(t)}}else e.innerHTML='<h2 style="text-align:center; margin-top:50px;">404 Not Found</h2>'}catch(t){console.error(t),e.innerHTML=`<p style="color:red; text-align:center;">Error: ${t.message}</p>`}};function w(s){document.querySelectorAll(".app-bar__navigation a").forEach(e=>{const i=e.getAttribute("href");i===s||s.startsWith("#/dashboard")&&i==="#/dashboard"?e.setAttribute("aria-current","page"):e.removeAttribute("aria-current")})}window.addEventListener("hashchange",P);window.addEventListener("load",P);"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const s=await navigator.serviceWorker.register("./sw.js");console.log("Service Worker registered with scope:",s.scope)}catch(s){console.error("Service Worker registration failed:",s)}});function G(s){if(!s)return;s.innerHTML="";const e=o("div",{class:"hero-text",style:"margin-bottom: 30px;"},[o("h2",{style:"font-size: 2.2rem; margin-bottom: 10px; font-weight: 800;"},"Merangkai Momen, Mengabadikan Cerita"),o("p",{style:"font-size: 1.1rem; opacity: 0.9; font-weight: 300;"},"Karena setiap detik berharga, kami hadir untuk menyimpannya.")]),i=(r,a,d)=>o("div",{style:"background: #f8fbff; padding: 20px; border-radius: 12px; transition: transform 0.3s; text-align: center;"},[o("div",{style:"font-size: 2rem; margin-bottom: 10px;"},r),o("h4",{style:"color: #024a7d; margin-bottom: 8px; font-size: 1.1rem; font-weight: bold;"},a),o("p",{style:"font-size: 0.9rem; color: #555; line-height: 1.5;"},d)]),n=o("div",{style:"background: white; border-radius: 20px; padding: 40px; color: #333; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.15); max-width: 850px; margin: 0 auto;"},[o("img",{src:"https://images.unsplash.com/photo-1522202176988-66273c2fd55f?q=80&w=800&auto=format&fit=crop",alt:"Connecting People",style:"width: 100%; height: 280px; object-fit: cover; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);"}),o("h3",{style:"color: #024a7d; margin-bottom: 20px; font-size: 1.6rem;"},"Visi Kami"),o("p",{style:"line-height: 1.8; color: #444; margin-bottom: 20px; font-size: 1.05rem;"},"Selamat datang di <strong>Dylan Story Super APP</strong>, sebuah ruang digital yang dirancang untuk menghubungkan hati melalui cerita. Kami percaya bahwa hidup adalah mozaik dari kepingan memori indah. Aplikasi ini hadir bukan sekadar sebagai galeri foto, tetapi sebagai <em>kapsul waktu</em> yang menjaga senyuman, petualangan, dan inspirasi Anda agar tetap hidup selamanya."),o("p",{style:"line-height: 1.8; color: #444; margin-bottom: 30px; font-size: 1.05rem;"},"Dibangun dengan integrasi teknologi terkini, kami memungkinkan Anda berbagi momen secara <em>real-time</em>, menandai jejak lokasi di setiap langkah perjalanan, dan tetap bisa diandalkan bahkan saat sinyal menjauh. Karena bagi kami, ceritamu terlalu berharga untuk dilewatkan."),o("p",{style:"line-height: 1.8; color: #888; margin-bottom: 30px; font-size: 0.9rem; font-style: italic; text-align: right;"},"Versi 5.0 - Edisi 2025"),o("div",{style:"display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 30px; padding-top: 30px; border-top: 1px solid #eee;"},[i("âš¡","Performa Kilat","Akses instan ke kenangan manismu tanpa waktu tunggu."),i("ðŸ—ºï¸","Jejak Petualangan","Tandai koordinat presisi di mana cerita itu bermula."),i("âœˆï¸","Mode Traveler","Simpan cerita saat offline, otomatis sinkron saat online."),i("ðŸ”’","Ruang Privat","Data lokal Anda tersimpan aman, kendali penuh di tangan Anda.")])]),t=o("div",{style:"display: flex; justify-content: center; gap: 20px; margin-top: 40px; padding-bottom: 40px; flex-wrap: wrap;"},[o("button",{style:"background-color: white; color: #024a7d; padding: 12px 35px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s;",onclick:()=>window.location.hash="#/dashboard"},"Kembali Ke Beranda"),o("button",{style:"background-color: #ff4757; color: white; padding: 12px 35px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 71, 87, 0.4); transition: transform 0.2s;",onclick:()=>{confirm("Yakin ingin meninggalkan aplikasi?")&&(localStorage.removeItem("token"),window.location.hash="#/")}},"Keluar Aplikasi")]);s.append(e,n,t)}
